{
  "$schema": "https://vega.github.io/schema/vega/v4.json",
  "title": "Team-wise Failed SVC Over Time",
  "width": 600,
  "height": 300,
  "padding": 5,

  "signals": [
    {
      "name": "selectedTeam",
      "value": "All",
      "bind": {
        "input": "select",
        "options": ["All", "TeamA", "TeamB"],
        "name": "Select Team: "
      }
    },
    {
      "name": "teamMap",
      "value": {
        "TeamA": ["svc1", "svc2"],
        "TeamB": ["svc3", "svc4"]
      }
    },
    {
      "name": "activeFailedSvcs",
      "update": "selectedTeam === 'All' ? null : teamMap[selectedTeam]"
    }
  ],

  "data": [
    {
      "name": "raw",
      "url": {
        "%context%": true,
        "%timefield%": "timestamp",
        "index": "hi_feed",
        "body": {
          "size": 10000,
          "_source": ["timestamp", "failed_svc"]
        }
      },
      "format": { "property": "hits.hits" },
      "transform": [
        {
          "type": "project",
          "fields": ["_source.timestamp", "_source.failed_svc"],
          "as": ["timestamp", "failed_svc"]
        },
        {
          "type": "filter",
          "expr": "!activeFailedSvcs || indexof(activeFailedSvcs, datum.failed_svc) >= 0"
        },
        {
          "type": "formula",
          "as": "team",
          "expr": "selectedTeam === 'All' ? 'All' : selectedTeam"
        },
        {
          "type": "formula",
          "as": "time_bin",
          "expr": "floor(toDate(datum.timestamp).getTime() / (1000*60*30)) * (1000*60*30)"
        }
      ]
    },
    {
      "name": "binned",
      "source": "raw",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["team", "time_bin"],
          "ops": ["count"],
          "as": ["count"]
        },
        {
          "type": "formula",
          "as": "time",
          "expr": "toDate(datum.time_bin)"
        }
      ]
    }
  ],

  "scales": [
    {
      "name": "xscale",
      "type": "time",
      "domain": { "data": "binned", "field": "time" },
      "range": "width"
    },
    {
      "name": "yscale",
      "type": "linear",
      "domain": { "data": "binned", "field": "count" },
      "nice": true,
      "range": "height"
    },
    {
      "name": "color",
      "type": "ordinal",
      "domain": { "data": "binned", "field": "team" },
      "range": { "scheme": "category10" }
    }
  ],

  "axes": [
    { "orient": "bottom", "scale": "xscale", "title": "Time" },
    { "orient": "left", "scale": "yscale", "title": "Count" }
  ],

  "legends": [
    {
      "fill": "color",
      "title": "Team",
      "orient": "right"
    }
  ],

  "marks": [
    {
      "type": "group",
      "from": {
        "facet": {
          "name": "teamFacet",
          "data": "binned",
          "groupby": "team"
        }
      },
      "marks": [
        {
          "type": "line",
          "from": { "data": "teamFacet" },
          "encode": {
            "enter": {
              "x": { "scale": "xscale", "field": "time" },
              "y": { "scale": "yscale", "field": "count" },
              "stroke": { "scale": "color", "field": "team" },
              "strokeWidth": { "value": 2 }
            }
          }
        }
      ]
    }
  ],

  "config": {
    "range": { "category": { "scheme": "category10" } },
    "mark": { "tooltip": true }
  }
}
